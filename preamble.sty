% vim:foldmethod=marker foldlevel=0
% Language {{{
\usepackage{polyglossia}
\setdefaultlanguage[numerals=cyrillic-alph,spelling=modern]{russian}
\setmainfont{Times New Roman}
\setmonofont{Consolas}
% \setotherlanguage{english}
\PolyglossiaSetup{russian}{indentfirst=true,langtag=RU}
% }}}
% Geometry {{{
\usepackage[left=3cm,right=1.5cm,vmargin=2cm]{geometry}
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{} % clear all header and footer fields
\fancyfoot[C]{\hspace{-1.5cm}\thepage} % except the center
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
% }}}
% Titlesec {{{
\usepackage{titlesec}
\titleformat{\section}{\bfseries}{\thesection}{1ex}{}{}
\titlespacing*{\section}{1.25cm}{1.2ex}{1.2ex}
\titleformat{\subsection}{\bfseries}{\thesubsection}{1ex}{}{}
\titlespacing*{\subsection}{1.25cm}{1.2ex}{1.2ex}
\titleformat{\subsubsection}{}{\thesubsubsection}{1ex}{}{}
\titlespacing*{\subsubsection}{1.25cm}{1.2ex}{1.2ex}
\titleformat{\paragraph}{}{\theparagraph}{1ex}{}{}
\titlespacing*{\paragraph}{1.25cm}{1.2ex}{1.2ex}
\titleformat{\subparagraph}[block]{\bfseries}{}{}{}
\titlespacing*{\subparagraph}{0cm}{1.2ex}{1.2ex}
\setcounter{secnumdepth}{4}

\usepackage{suffix}
\newcommand\csec[1]{%
    \subparagraph{\centerline{#1}}
    \addcontentsline{toc}{section}{#1}%
}
\WithSuffix\newcommand\csec*[1]{%
    \subparagraph{\centerline{#1}}%
}
% }}}
% Toc {{{
\usepackage{titletoc}
\dottedcontents{section}[1.3em]{}{1.3em}{0.6em}
\dottedcontents{subsection}[2.0em]{}{2.0em}{0.6em}
\dottedcontents{subsubsection}[2.7em]{}{2.7em}{0.6em}
\dottedcontents{paragraph}[3.4em]{}{3.4em}{0.6em}

\addto{\captionsrussian}{\renewcommand*{\contentsname}{%
\centerline{СОДЕРЖАНИЕ}\vspace{-1em}}%
}

\setcounter{tocdepth}{4}   
% }}}
% Page/par {{{
\setlength{\parindent}{1.25cm}
\frenchspacing

\usepackage{setspace}
\onehalfspacing%

% \tolerance=1
\emergencystretch=\maxdimen{}
% \hyphenpenalty=10000
% \hbadness=10000
\hyphenchar\font=-1
% \usepackage[none]{hyphenat}

\usepackage{blindtext}
% }}}
% Hyperref, footnotes {{{
\usepackage{hyperref}
\hypersetup{
    hidelinks,
    breaklinks=true
}
\urlstyle{same}

\usepackage[bottom]{footmisc}
\setlength{\footnotemargin}{13.5mm}
% }}}
% Math {{{
\usepackage{amsmath,amsfonts,amssymb,amsthm,mathtools}
\usepackage{icomma} % $0,2$ --- число, $0, 2$ --- перечисление
% }}}
% Lists {{{
\usepackage{enumitem}
\makeatletter
\renewcommand*{\Asbuk}[1]{%
\protect\StrChar{АБВГДЕЖИКЛМНПРСТУФХЦШЩЭЮЯ}{\the\@nameuse{c@#1}}%
}
\renewcommand*{\asbuk}[1]{%
\protect\StrChar{абвгдежиклмнпрстуфхцшщэюя}{\the\@nameuse{c@#1}}%
}
\AddEnumerateCounter{\asbuk}{\asbuk}
\makeatother
\setlist{nosep,wide}
\setlist[2]{labelindent=\parindent}
\setlist[enumerate]{label={\arabic*)},ref=\arabic*}
\setlist[enumerate,2]{label={\asbuk*)},ref=\asbuk*}
\setlist[itemize]{label={--}}
\setlist[itemize,2]{label={---}}
% }}}
% Graphics/Tikz {{{
\usepackage{graphicx}
\graphicspath{{images/}{../images/}{screenshots/}{../screenshots/}}
\usepackage{float}

\usepackage{tikz}
\usetikzlibrary{arrows.meta,graphs,shapes}
% }}}
% Captions {{{
\addto\captionsrussian{\renewcommand{\figurename}{Рис}}
\addto\captionsrussian{\renewcommand{\tablename}{Тaблица}}
\usepackage[font=small,labelsep=endash]{caption}
\captionsetup[table]{justification=raggedright,singlelinecheck=false}
\captionsetup[listing]{justification=raggedright,singlelinecheck=false,skip=-6pt}
% }}}
% Tables {{{
\usepackage{array,tabularx,tabulary,booktabs,longtable}
\usepackage{diagbox}
% set longtable left alignment
\setlength\LTleft{0pt}
\setlength\LTright{\fill}
\usepackage{multirow}
\renewcommand{\arraystretch}{1} % вертикальный просвет между строками
% }}}
% Minted {{{
\usepackage[outputdir=out/,newfloat]{minted}
% \usemintedstyle{bw}
\setminted{
    % xleftmargin=12pt,
    % framesep=2mm,
    fontsize=\footnotesize,
    autogobble,
    breaklines=true,
    breakautoindent=false,
    frame=lines,
    numbers=left,
    numbersep=8pt,
    baselinestretch=1,
    tabsize=4
}
\usepackage{etoolbox}
\BeforeBeginEnvironment{minted}{\vspace{-10pt}}
\AfterEndEnvironment{minted}{\vspace{-10pt}}
\BeforeBeginEnvironment{listing}{\vspace{-3pt}}
\AfterEndEnvironment{listing}{\vspace{-15pt}}
\SetupFloatingEnvironment{listing}{name=Листинг}
% }}}
% Counters {{{
\usepackage{lastpage}
\usepackage{totcount}
\newtotcounter{tables}
\newtotcounter{figures}
\newtotcounter{bibitems}
\newtotcounter{apps}
% }}}
% Bibliography {{{
\usepackage{cite,csquotes}

\addto\captionsrussian{\def\refname{СПИСОК ЛИТЕРАТУРЫ}}

\makeatletter
\renewcommand*{\@biblabel}[1]{\hfill#1}
\renewenvironment{thebibliography}[1]
    {\csec{\refname}
        \list{\@biblabel{\@arabic\c@enumiv}}
           {\settowidth\labelwidth{\@biblabel{#1}}
            \leftmargin\labelsep
            \itemindent 16.7mm
            \@openbib@code
            \usecounter{enumiv}
            \let\p@enumiv\@empty
            \renewcommand\theenumiv{\@arabic\c@enumiv}
        }
        \setlength{\itemsep}{0pt}
    }
\makeatother
% }}}
% Appendx {{{
\usepackage{chngcntr}
\newenvironment{apps}
{
    \appendix
    \titleformat{\subsubsection}{\bfseries}{\thesubsubsection}{1ex}{}{}
    \renewcommand{\thesection}{\Asbuk{section}}%
    \titleformat{\section}{\bfseries\centering}{\thesection}{1ex}{}{}%
    \renewcommand\thefigure{\thesection.\arabic{figure}}%
    \renewcommand\thetable{\thesection.\arabic{table}}%
    \renewcommand\thelisting{\thesection.\arabic{listing}}%
    \setcounter{figures}{\value{figure}}%
    \setcounter{tables}{\value{table}}%
    \setcounter{figure}{0}%
    \setcounter{table}{0}%
    \counterwithin{figure}{section}%
    \counterwithin{table}{section}%
    \counterwithin{listing}{section}%
}
{
    \addtocounter{figures}{\value{figure}}%
    \addtocounter{tables}{\value{table}}%
}

% \makeatletter
% \newcommand\appendix@section[1]{%
%   \refstepcounter{section}%
%   \orig@section*{ПРИЛОЖЕНИЕ  \@Alph\c@section~#1}%
%   \addcontentsline{toc}{section}{ПРИЛОЖЕНИЕ \@Alph\c@section~#1}%
%   \stepcounter{apps}%
% }
% \let\orig@section\section
% \g@addto@macro\appendix{\let\section\appendix@section}
% \makeatother

\makeatletter
\newcommand\appendix@section[1]{%
  \refstepcounter{section}%
  \orig@section*{ПРИЛОЖЕНИЕ  \Asbuk{section}~#1}%
  \addcontentsline{toc}{section}{ПРИЛОЖЕНИЕ \Asbuk{section}~#1}%
  \stepcounter{apps}%
}
\let\orig@section\section
\g@addto@macro\appendix{\let\section\appendix@section}
\makeatother
% }}}
